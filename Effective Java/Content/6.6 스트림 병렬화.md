# 스트림 병렬화
* 순차적으로 수행되는 스트림 파이프라인의 연산들을 병렬로 수행
* 스트림 파이프라인에 parallel 연산자(마킹 연산자)를 추가하여 병렬 연산 수행
```java
List<Integer> list = Arrays.asList(1,2,3,4,5,6,7,8);
list.stream().filter(e -> e > 5).parallel.foreach(e -> ++e);
```

* 병렬 스트림 연산 수행시, 내부적으로 정의되어있는 ForkJoinPool 사용 

### 스트림 병렬화 주의사항
* 스트림을 잘못 병렬화 할시, 데드락에 빠지기 쉽고, 성능이 오히려 더 나빠지거나, 결과 자체가 잘못될 수도 있음
* 스트림 병렬화를 통해 성능이 개선되는 조건은 매우 까다롭고 실제로 개선되는 경우도 많지 않음
* 하지만 조건만 잘 갖추면 드라마틱한 성능향상을 얻을 수 있으므로 성능개선이 필요하다면 시도해보는것도 좋음
* 병렬화시 스트림 파이프라인의 정상 동작과 성능 개선이 확실하게 확인된 경우에만 병렬화 적용 

# 스트림 병렬화의 조건
### 1. 스트림 소스
* 스트림의 소스는 
	1. 원소를 원하는 크기로 쉽게 나눌 수 있어야 하고
	2. 원소들의 참조 지역성이 뛰어난 객체이어야 함
* ArrayList, HashMap, HashSet, ConcurrentHashMap, 배열, IntRange, LongRange

cf) 참조지역성 : 컬렉션 내 이웃한 원소끼리 서로 가까운 위치에 저장되어있는 속성

### 2. 종단연산
1. 종단연산의 연산량이 작야한다.
	* 종단연산의 연산량이 스트림파이프라인 전체 연산량에서 비중이 크다면 병렬화가 효과가 줄어듬(종단연산은 병렬화 불가능??)
2. 종단연산의 종류가 축소연산이나 조건연산이어야 한다.
	* 축소연산 : 스트림내 모든 원소들을 하나의 결과값으로 합치는 연산(reduce, min, max, count, sum)
	* 조건연산 : 컬렉션내 조건식 predicate을 만족하는 원소가 존재하는지 검사하는 연산(anyMatch, allMatch, noneMatch)

### 3. 연산량
* 스트림 파이프라인 전체 과정에서 총 수행되는 코드 줄 수가 수십만 줄 이상이어야 함
	* 스트림 연산에 쓰이는 원소 수와 각 원소당 수행되는 코드 줄수의 곱이 수십만 줄 이상이어야 병렬화시 성능 향상이 큼
	

#### cf) 난수 생성기
* 병렬 스트림에서 스트림연산 중 난수 생성이 필요하다면 ThreadLocalRandom 대신 멀티 스레딩 전용으로 설계된 SplittableRandom 사용