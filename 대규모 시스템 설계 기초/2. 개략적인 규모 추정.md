# 일반적으로 서버 어플리케이션에서 수행되는 로직의 latency

| 로직 | description | latency |
|:--:|:--:|:--:|
| 압축 | snappy 로 1kb 압축 | 10 μs |
| 메모리 IO | 메모리에서 1MB read | 250 μs |
| 네트워크 IO | 네트워크에서 1MB read | 10 ms |
| 디스크 탐색 | 특정 디스크 위치로 디스크 head 를 이동시키는것 | 10 ms |
| 디스크 IO | 디스크에서 1MB read | 30 ms |
| Last mile latency | 캘리포니아 <-> 네덜란드간 패킷 왕복 | 150 ms |

* 디스크 IO(탐색 포함) 는 가능한 한 지양
* 네트워크로 데이터 전송시 (요청/응답) 압축하여 전송
* 글로벌 서비스의 경우 localized 데이터 센터 구축 고려


# 개략적 규모 추정
* 웹서비스 트래픽과 관련된 정보들이 제공되었을때, 트래픽 규모 및 필요한 리소스 양 추정하는것
* 웹서빗 트래픽 관련 정보
  * MAU
  * User 이용 패턴
  * 요청/응답 데이터 크기
  * 데이터 관리 정책
* 트래픽 규모 및 필요한 리소스 양 추정
  * 평균 RPS
  * 최대 RPS
  * 저장소 크기
  * 캐시 크기
  * 서버 스펙 및 대수
  * nic capacity

### 사고실험
* 가정
  * MAU : 3억명
  * 이용패턴
    * 50% 의 사용자는 트위터를 매일 이용
    * 평균적으로 각 사용자는 일간 2건의 트윗을 게시
    * 이중, 미디어를 포함한 트윗은 10% 이고, 평균 미디어 크기는 1MB
  * 데이터 관리 정책 : 사용자가 업로드한 미디어 파일의 retention 기간은 5년
* 추정
  * 평균 RPS
    * DAU 는 MAU 의 50% 인 1.5 억명
    * 사용자는 트윗 게시 요청만 한다 했을때, DAU 한명당 하루 요청량은 2건
    * 그렇다면, 서버로 인입되는 하루 총 요청량은 3억 건(1.5억 * 2)
    * 평균 RPS 는 약 3500 (3억 건 / 24(시간) / 60(분) / 60(초))
  * 최대 RPS
    * MAU 가 모두 접속하여 요청을 전송하는 상태가 최대 RPS 상태
    * 따라서 최대 RPS 는 약 7000 (6억 건 / 24(시간) / 60(분) / 60(초))
  * 저장소 크기
    * 하루 총 요청량중, 미디어를 포함한 요청수는 3000 만건 (3억건 * 10%)
    * 하루에 업로드되는 전체 미디어 크기는 30 TB
    * retention 기간인 5년동안 저장될 전체 미디어 크기는 약 55 PB (30TB * 365 * 5)
    * 따라서 필요한 저장소 크기는 55 PB

### 규모 추정시 고려사항
* 어플리케이션에 캐시가 적용되어있는경우, 캐시 fill 상태일때와 아닐때의 트래픽을 각각 고려하여야한다.
* 일반적으로 서버 스펙 및 대수 산정시, 평균 RPS 의 3배 트래픽까지 수용 가능한정도의 수준으로 산정한다.
  * e.g. 평균 트래픽 값이 20mbps일 경우, 60mbps가 서비스의 안전 트래픽.
* 최대 RPS 는 여러가지 케이스가 있다. 1, 2의 경우는 보통 시기에 맞춰 임시로 서버를 증설하는식으로 대응한다.
  1. 특정 시기(e.g. 크리스마스, 블랙프라이데이)에 사용자가 몰려서 최대 RPS 가 발생하는경우
  2. 특정 이벤트나, 홍보등을 진행하여 사용자가 증가해 최대 RPS 가 발생하는 경우
  3. 평균적인 최대 RPS


# TPS(RPS) - QPS 차이
* 예를 들어 우리가 어떤 페이지를 방문한다고 생각해보자.
* 이때 방문한 페이지에는 게시글, 댓글, 광고, 인기 글 등의 정보들이 보인다고 하자.
* 우리가 페이지를 방문하면 하나의 TPS가 발생한다.
* 하지만 실제로는 게시글 조회, 댓글 조회, 광고 조회, 인기글 조회 등 4번의 특정 서버 요청이 발생하게 되고
* 이것을 QPS라고 볼 수 있다. 즉, 1 TPS와 4 QPS가 형성된다.




