# 파티션 개수
* 카프카의 메시지 처리 성능(throughput)은 토픽의 파티션 수, 컨슈머 수에 따라 결정
	* 파티션수, 컨슈머 수를 함께 늘려줘야 성능 증가
* 그러나, 파티션수, 컨슈머수를 늘린다고 항상 성능이 좋아지는것이 아님

### 파티션 증대에 따른 trade-off
1. 파일 핸들러 낭비
* 브로커는 모든 세그먼트 파일(파티션의 메시지 데이터 저장소)의 파일 핸들러(open file handle)를 유지한채로 관리 
* 각 세그먼트 파일은 메시지 데이터 저장파일, 그 데이터의 인덱스 파일 2개로 구성되므로 하나의 파티션당 2개의 파일 핸들러 필요
* 파티션의 개수가 많아지면, 그만큼 유지해야하는 파일 핸들러의 개수도 많아지므로 메모리 사용량이 많아지고 부하 증대

2. 장애 복구 시간 증가
* 장애등으로 인해 리더파티션이 사용 불가능해질경우, 컨트롤러 브로커에서 자동으로 팔로워 파티션중 하나를 다시 리더로 선출
* 한 브로커 장비에 장애가 발생하여, 해당 브로커의 리더파티션들을 재선출할경우, 재선출하는과정에서 부하 및 딜레이가 발생
* 이 딜레이는 장애가 발생한 브로커에서 관리하던 리더파티션의 개수가 많아질수록 증가
	* 브로커에 1000개의 리더파티션이 있고, 하나의 리더파티션 재선출에 5ms 가 걸린다면, 1000개의 리더파티션 재선출에는 5초가 소요
* 브로커 당 파티션 수를 4000개 이하로 제한 권장

3. 파티션 변경 내용 복제 부하 증가
* 파티션 개수가 많아질수록 리더 파티션의 변경내용을 팔로워 파티션이 가져와 복사하는 과정의 부하 증대
* ISR(In Sync Replica)  로 유지하기 위해 팔로워 파티션들은 매우 짧은 주기로 리더 파티션의 변경 내용 조회하여 적용
* 변경내용 전송 작업은 단일 스레드로 이루어지며, 1000개의 리더 파티션 변경 내용 복제시, 약 20ms 소요
* 브로커 당 파티션 수를 100 x 브로커 수 x replica factor로 제한 권장

4. 프로듀서 메모리 증가
* 0.8.2 버전부터 프로듀서에서 토픽의 각 파티션에 전송할 메시지를 버퍼링
* 파티션의 개수가 많아질수록 프로듀서에 버퍼링되는 메시지 크기도 커지고, OOM 에러 발생 위험 증가
* 컨슈머 또한, 각 파티션의 메시지를 벌크로 컨슈밍하므로, 파티션 개수가 많아지면, 더 많은 메모리 사용

### 적정 파티션 개수 판단
* 토픽에 대해 초당 프로듀스 되는 메시지 수와 컨슈머 그룹의 각 컨슈머의 메시지 처리 성능에 따라 파티션 개수 및 컨슈머 개수 설정
	* e.g. 평균 초당 10개의 메시지를 프로듀스하는 프로듀서 4개, 초당 5개의 메시지를 처리하는 컨슈머 > 파티션 8개 + 컨슈머 8개 로 설정
* 적절한 파티션 수 예측이 어려울 경우, 우선 적은 수의 파티션으로 운용, 메시지 처리의 병목 발생시 파티션, 컨슈머 늘려가며 튜닝
	* 런타임중, 토픽의 파티션수 증가는 자유롭게 가능하나, 축소는 불가능하므로 

<br>

# 브로커 디스크 IO 성능
* 브로커 디스크 IO 성능에 따라 프로듀서의 메시지 프로듀스 성능 결정
	* 프로듀서에서 메시지 프로듀스시, 브로커에서 메시지를 세그먼트파일에 저장 후, offset 커밋 완료하여 확인응답을 줄때까지 프로듀서는 대기
	* 따라서 브로커의 세그먼트 파일(디스크)write 속도가 빠를수록 Producer 대기시간 감소
* 컨슈머의 메시지 컨슈밍 또한 브로커의 세그먼트 파일을 read 하여 수행하는것이므로 디스크 IO 성능에 영향 

### 브로커 추가
* 브로커의 디스크 공간이 부족하거나, CPU 리소스가 부족할때 토픽에 브로커 추가 및 파티션 재분배 수행
* 카프카에서 권장하는 최소 replication-factor 값인 3에 따라, 토픽당 최소 3개 이상의 브로커 구성

<br>

# 브로커 페이지 캐시 크기
* 애플리케이션에 할당된 메모리를 제외한 나머지 잔여 메모리를 페이지 캐시로 사용 하므로, 잔여 메모리가 클 수록 브로커의 IO 성능 향상
* 따라서 카프카 서버에 다른 어플리케이션을 함께 실행하는 것을 권장하지 않으며, 카프카 또한 5gb 정도의 메모리면 충분

***
> Reference
> * https://knight76.tistory.com/entry/kafka-lag-%EC%83%9D%EA%B8%B4%EB%8B%A4%EA%B3%A0-%ED%8C%8C%ED%8B%B0%EC%85%98-%EC%B6%94%EA%B0%80%ED%95%98%EB%8A%94-%EA%B2%83%EC%97%90-%EB%8C%80%ED%95%B4
> * https://allg.tistory.com/65
> * https://devidea.tistory.com/95?category=762832
> * https://brocess.tistory.com/79
> * https://needjarvis.tistory.com/602