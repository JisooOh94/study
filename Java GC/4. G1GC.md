# ***G1GC(-XX:+UseG1GC)***
<br>

* 대용량의 메모리를 가진 멀티프로세서 시스템에 적합한 GC
* 대용량의 메모리를 GC 하면서 STW 시간을 최소화
* CMS GC 와 마찬가지로 부분 Real time GC
* Java 6 부터 사용가능(but Java 8 이상이어야 성능이 좋음)하며 Java 9 부터 default GC 로 채택됨
* STW 시간을 최소화 하기 위해 멀티스레드로 GC 수행

# 메모리(Heap) 공간 구성
![image](https://user-images.githubusercontent.com/48702893/85925930-a17c2000-b8d6-11ea-8210-8147f8bb93d4.png)
* 전체 Heap 메모리 공간을 2차원 배열형태로 region 이란 고정된 크기 공간으로 나눔
* unused region들을 eden, survivor, old generation, homongous 영역으로 할당하여 사용
* G1GC 사용시, JVM에서 전체 Heap 메모리 공간을 2048(default) 개로 나눌수 있는 크기로 region 크기 설정
> e.g. 전체 Heap 메모리 크기가 8GB 일경우 default region size 는 4mb(8192mb / 2048)
* 개발자가 직접 -XX:G1RegionSize JVM 옵션을 통해 1 ~ 32 mb 사이로 region 크기 튜닝 가능하나 추천하지 않음

### homongous 영역
* 크기가 큰 객체를 저장하기 위한 별도의 영역
* 메모리에 저장하려는 객체가 region 크기의 1/2 보다 큰경우, homongous 영역에 저장
* homongous 영역에 저장된 객체는 별도의 GC 프로세스 없이 참조가 사라질경우 삭제

# G1GC minor GC(Evacuation)
* Eden region 의 객체들을 ToSurvivor region 으로, FromSurvivor region의 객체들을 ToSurvivor region 으로, ToSurvivor region 의 객체들을 Old Gen region 으로 복사 후 GC 대상 region clear
* FromSurvivor region : GC 대상인 Survivor region, ToSurvivor region : 비어있는 region
   > 다른 HotSpot VM GC 처럼 FromSurvivor region, ToSurvivor region 이 정해져있는것이 아님
* STW 로 수행되므로 STW 시간을 최소화 하기 위해 멀티스레드로 수행됨

### minor GC 실행 조건 
* 블로그 정보들에 따르면 개발자가 JVM 옵션으로 지정한 pause duration 과 PerByteCopyingCost 에 의해 실행된다고 되어있는데 정확하지 않음
* 추가 조사 및 학습 필요

### GC 대상 region 선택 알고리즘
* 죽은 객체들이 저장되어있는 region 들중 일부를 선택하여 GC 수행
* 각 region 의 Live Data Counting 정보 + 최대 복사 가능 Byte 크기 를 기반으로 GC 대상 선택
* 각 region은 마킹 프로세스 후, 살아있는 객체 수를 저장한 Live Data Counting 정보를 가지고있음
* 최대 복사 가능 Byte 크기 = PauseMillis / PerByteCopyingCost
   * PauseMilis : -XX:MaxGCPauseMillis JVM 옵션으로 설정한 최대 일시 정지 시간
   * PerByteCopyingCost : 단위 바이트 복사당 소요될 Cost
* GC 후보 region 들중 총 N개(최대 복사 가능 Byte 크기를 기반으로 산출)의 region을 선택
* N개의 region 선택시 Live Data Counting 이 적은 순서(공간 활용률 떨어지는 순서)대로 선택하는것으로 추정

### 실행 과정
1. External Root Scanning : GC Thread 들이 레지스터, 스레드 스택등에서 GC root 를 탐색하는 단계
2. Update RS : GC root 로부터 객체들의 참조를 탐색하여 각 region 의 Remembered set(RS) 영역에 갱신
   * Remembered Set : region 내의 객체들에 대한 외부에서의 참조 레퍼런스 저장 영역(white barrier 의 카드테이블과 유사)
3. Scan RS : GC 대상인 reigon은 RS 을 순회하며 region 내에 live 객체들 탐색
4. Object Copy : Scan RS에서 탐색한 객체들을 다른 Region으로 복사. 
5. Termination : region clear

* minor GC 때마다 Eden - Survivor 영역 크기 비율 조정됨
* Survivor 영역 - liveness object 판단, Eden 영역 - pause time 예측??